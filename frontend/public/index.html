<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClassEngage Health Check</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        display: flex;
        flex-direction: column;
        gap: 2rem;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: #f7fafc;
        padding: 1rem;
      }
      section {
        background: #fff;
        padding: 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        width: 100%;
      }
      h1 {
        margin-top: 0;
      }
      h2 {
        font-size: 1.25rem;
        margin-bottom: 1rem;
      }
      button {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
        border-radius: 0.5rem;
        border: none;
        background: #2563eb;
        color: #fff;
        cursor: pointer;
        margin-bottom: 1rem;
      }
      button:hover {
        background: #1d4ed8;
      }
      pre {
        background: #0f172a;
        color: #f8fafc;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
      }
      .session-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .session-card {
        background: #f1f5f9;
        padding: 1rem;
        border-radius: 0.375rem;
        border-left: 4px solid #2563eb;
      }
      .session-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
      }
      .session-meta {
        color: #64748b;
        font-size: 0.9rem;
      }
      .empty-message {
        color: #64748b;
        font-style: italic;
        text-align: center;
        padding: 2rem;
      }
    </style>
  </head>
  <body>
    <section>
      <h1>ClassEngage Health Check</h1>
      <h2>API Status</h2>
      <button id="ping">Check Health</button>
      <pre id="output">Click the button to fetch /health</pre>
    </section>

    <section>
      <h2>Available Sessions</h2>
      <button id="fetch-sessions">Fetch Sessions</button>
      <div id="sessions-output">Click the button to load sessions</div>
    </section>

    <script>
      // ============================================================
      // Health Check Example
      // ============================================================
      // This demonstrates a simple GET request to check API status.
      // The fetch API is native to modern browsers and returns a Promise.

      const pingButton = document.getElementById('ping');
      const output = document.getElementById('output');

      pingButton.addEventListener('click', async () => {
        // Provide immediate feedback to the user
        output.textContent = 'Checking…';
        
        try {
          // fetch() initiates an HTTP request. Default method is GET.
          // It returns a Promise that resolves to a Response object.
          const response = await fetch('http://localhost:8000/health');
          
          // Always check response.ok (status 200-299) before parsing
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          // Parse JSON body from the response
          const data = await response.json();
          
          // Display formatted JSON in the <pre> element
          output.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          // Network errors, parse failures, or thrown errors land here
          output.textContent = `Error: ${error.message}`;
        }
      });

      // ============================================================
      // Fetch Sessions Example
      // ============================================================
      // This shows how to fetch a list, handle empty results,
      // and dynamically build HTML from API data.

      const fetchSessionsButton = document.getElementById('fetch-sessions');
      const sessionsOutput = document.getElementById('sessions-output');

      fetchSessionsButton.addEventListener('click', async () => {
        // Clear previous content and show loading state
        sessionsOutput.textContent = 'Loading sessions…';
        
        try {
          // GET request to retrieve sessions list
          const response = await fetch('http://localhost:8000/sessions');
          
          // Check for HTTP errors (4xx, 5xx)
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          // Parse the response body as JSON (expects an array)
          const sessions = await response.json();
          
          // Handle empty results gracefully
          if (sessions.length === 0) {
            sessionsOutput.innerHTML = '<div class="empty-message">No sessions available</div>';
            return;
          }

          // Transform API data into HTML. Use .map() to iterate over each session.
          // Always escape user-provided data to prevent XSS attacks.
          const sessionCards = sessions.map(session => `
            <div class="session-card">
              <div class="session-title">${escapeHtml(session.title)}</div>
              <div class="session-meta">
                Code: <strong>${escapeHtml(session.code)}</strong> • 
                Host: ${escapeHtml(session.host.display_name)} • 
                Status: ${escapeHtml(session.status)}
              </div>
            </div>
          `).join('');

          // Inject the generated HTML into the container
          sessionsOutput.innerHTML = `<div class="session-list">${sessionCards}</div>`;
        } catch (error) {
          // Display any errors (network issues, invalid JSON, etc.)
          sessionsOutput.textContent = `Error: ${error.message}`;
        }
      });

      // ============================================================
      // Security Helper: HTML Escaping
      // ============================================================
      // ALWAYS escape user-provided content before inserting into innerHTML.
      // This prevents Cross-Site Scripting (XSS) attacks where malicious
      // code could be injected via API data.
      //
      // How it works:
      // 1. Create a temporary DOM element
      // 2. Set textContent (automatically escapes special chars)
      // 3. Read back innerHTML to get the escaped string
      //
      // Example: escapeHtml('<img src=x onerror=alert(1)>')
      //   returns: '&lt;img src=x onerror=alert(1)&gt;'

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ============================================================
      // Tips for Frontend Developers
      // ============================================================
      //
      // 1. ASYNC/AWAIT vs PROMISES
      //    async/await is syntactic sugar over Promises. These are equivalent:
      //
      //    fetch(url).then(res => res.json()).then(data => console.log(data));
      //    const res = await fetch(url); const data = await res.json(); console.log(data);
      //
      // 2. ERROR HANDLING
      //    - fetch() only rejects on network failures, NOT HTTP errors (404, 500, etc.)
      //    - Always check response.ok before parsing the body
      //    - Wrap fetch calls in try/catch to handle all error types
      //
      // 3. HTTP METHODS
      //    Default is GET. For POST requests:
      //
      //    fetch(url, {
      //      method: 'POST',
      //      headers: { 'Content-Type': 'application/json' },
      //      body: JSON.stringify({ title: 'New Session', host_display_name: 'Prof. X' })
      //    });
      //
      // 4. CORS (Cross-Origin Resource Sharing)
      //    If your frontend runs on a different origin (domain/port),
      //    the backend must include CORS headers. FastAPI handles this
      //    via CORSMiddleware configuration.
      //
      // 5. LOADING STATES
      //    Always provide feedback during async operations:
      //    - Show "Loading..." text immediately on button click
      //    - Replace with data or error message when complete
      //    - Consider disabling buttons during requests to prevent duplicate calls
      //
      // 6. SECURITY
      //    - Never trust API data; always escape before rendering
      //    - Use textContent for plain text, escapeHtml() for innerHTML
      //    - Validate/sanitise input on both client AND server
      //
      // 7. API DOCUMENTATION
      //    See docs/api/sessions.md for endpoint specs, response schemas,
      //    and example requests/responses.
      //
      // ============================================================
    </script>
  </body>
</html>
